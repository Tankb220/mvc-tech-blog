var assert = require("assert")
var inspect = require("util").inspect
var compile_jass = require("../lib/jass.js")

var n_tests = 0

process.on("exit", function () {
  if (typeof n_tests === "number") {
    console.log("%d tests OK.", n_tests)
  }
})

process.on("uncaughtException", function (error) {
  if (error instanceof assert.AssertionError) {
    console.log(
      "[FAIL] expected %s, got %s",
      inspect(error.expected),
      inspect(error.actual)
    )
    n_tests = undefined
    process.exit()
  } else {
    console.log(error.stack)
  }
})

function test(source, expected, locals) {
  compile_jass(source, {
    filename: __filename,
    locals: locals
  }, function (error, result) {
    ++n_tests, assert.equal(result, expected)
  })
}

//——————————————————————————————————————————————————————————

test("a /*=1+2*/ b /*=3+4*/", "a 3 b 7", {})
test("a /*=foo*/ b", 'a "123" b', { foo: "123" })
test('a\n//@include "./fixtures/foo.js"\nb', "a\n123\nb", {})
